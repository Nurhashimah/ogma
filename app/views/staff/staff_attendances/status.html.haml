-model_class = StaffAttendance
.page-header
  %h1= t('staff_attendance.status_punchcard')
= render 'shared/flashes'
  
.navbar.navbar-inverse{role: "navigation", style: "padding-right:40px;"}
  %ul.nav.navbar-nav.navbar-right
    %li.toga= link_to content_tag(:li, fa_icon("search", text: (t 'actions.search'))), "#", class: 'bogus'
    %li= link_to content_tag(:li, fa_icon("print", text: (t 'actions.print'))), "#", class: 'bogus'

/- @all_dates_staffs = StaffAttendance.find(:all, :conditions =>['logged_at>=? and logged_at<?',"2012-05-07","2012-10-16"], :order => 'logged_at ASC')
- @all_dates_staffs = StaffAttendance.find(:all, :conditions =>['logged_at>=? and logged_at<?',"2012-05-07","2014-01-01"], :order => 'logged_at ASC')   
- @logged_at_list =[] 
- for all_dates_staff in @all_dates_staffs.map(&:logged_at)
  - @logged_at_list << all_dates_staff.in_time_zone('UTC').to_date.beginning_of_month.to_s
  
- @title_for_month= @logged_at_list.uniq 
- @all_thumbs = @all_dates_staffs.map(&:thumb_id).uniq.sort
- @staff_info = Staff.find(:all, :conditions=> ['thumb_id IN (?)',@all_thumbs], :order=>'thumb_id ASC', :select=>"thumb_id, name,id")
- @staff_thumb = Staff.find(:all, :conditions=> ['thumb_id IN (?)',@all_thumbs], :order=>'thumb_id ASC').map(&:thumb_id) 
/ for checking : @staff_name = Staff.find(:all, :conditions=> ['thumb_id IN (?)',@all_thumbs], :order=>'thumb_id ASC').map(&:staff_thumb) 
- @all_dates = @all_dates_staffs.group_by{|x|x.thumb_id}

/=StaffAttendance.find(:all, :conditions => ["trigger IS TRUE AND is_approved IS FALSE AND thumb_id =? AND logged_at>=? AND logged_at<?", 773, "2012-10-01", "2012-11-01"], :order => 'logged_at DESC').count
/=StaffAttendance.find(:all, :conditions => ["trigger IS TRUE AND is_approved IS FALSE AND thumb_id =? AND logged_at>=? AND logged_at<?", 772, "2012-10-01", "2012-11-01"], :order => 'logged_at DESC').count
- year_group = @title_for_month.group_by{|x|x.to_date.year}
.row
  %table.table-striped.table-hover.ogma
    %thead
      %tr
        %th{:rowspan=>"2"} No
        %th{:rowspan=>"2"}=t 'staff_attendance.thumb_id'		# sort_link(@search, :time_in, (t 'attendance.time_in'))
        %th{:rowspan=>"2"}=t 'staff_attendance.unit_department'	# sort_link(@search, :time_out, (t 'attendance.time_out'))
        - year_group.each do |years, months|
          %th{:colspan=>"#{months.count}", :style=>"text-align: center;"}=years
      %tr
        - year_group.each do |y,m|
          - m.each do |month2|
            %th=month2.to_date.strftime("%b")

    %tbody
      /= render "index_search"
      - @all_dates.keys.sort.each_with_index do |thumbid, index|
        %tr
          %td=index+1
          %td
            /for checking=@all_thumbs[index]
            - unless @staff_thumb.include?(@all_thumbs[index])
              %font{:color=>"red"}Staff not exist in Staff Info (thumb_id : "#{@all_thumbs[index]}")
            - else
              - @staff_info.each do |staff| 
                = staff.staff_thumb if staff.thumb_id == @all_thumbs[index]
          %td
            - unless @staff_thumb.include?(@all_thumbs[index])
              %font{:color=>"red"}No record
            - else
              - @staff_info.each do |staff|
                = staff.render_unit if staff.thumb_id == @all_thumbs[index]
       
          - @all_begin_months = []
          - for dailydate in @all_dates[thumbid].map(&:logged_at)
            - @all_begin_months << dailydate.in_time_zone('UTC').to_date.beginning_of_month.to_s     
            - @in_column = []
            - count_status = 0 
            - for every_month_begin in @all_begin_months.uniq
              - if count_status == 0
                - previous_stat = 1
                - previous_status = StaffAttendance.monthly_colour_status(every_month_begin, thumbid,previous_stat)
              - else
                - previous_status = StaffAttendance.monthly_colour_status(every_month_begin, thumbid,previous_stat)
              - 0.upto(@title_for_month.count-1) do |count2|
                - if every_month_begin == @title_for_month[count2]
                  - @in_column[count2] = previous_status

              - previous_stat = previous_status
              - count_status+=1

          - 0.upto(@title_for_month.count-1) do |count2| 
            - if @in_column[count2] == 1
              %td{:style=>"background:#F7F3A4;text-align:center;"}K
            - elsif @in_column[count2] == 2 
              %td{:style=>"background:#7C8;text-align:center;"}H
            - elsif @in_column[count2] == 3
              %td{:style=>"background:#F77;text-align:center;"}M
            - else
              %td &nbsp
                
/UNHIDE for checking
/              %td
/                - count3=0 
/                 -  for begin_month in @all_begin_months.uniq %>    display beginning month set of each staff
/                    = begin_month
/                    - count3+=1
/                     - if count3 < @all_begin_months.uniq.count-1
/                       ,
/                      thumb_id = 
/                      =thumbid

            
/        %td{:colspan=>"7",:style=>"font-weight: bold; background-color: #D8D8D8;"}=t 'attendance.late_to_approve'
/<table border=1>
/	<tr>
/		<th rowspan=2>No</th>
/		<th rowspan=2>Staff Name</th>
/		<th rowspan=2>Department</th>
/		<th colspan="<%=@title_for_month.count%>"><%=@title_for_month[0].to_date.strftime("%Y") %></th>
/		-UNHIDE for checking..
/		<th rowspan=2>Total Month</th>
/	</tr>
/	<tr>
/		<% 0.upto(@title_for_month.count-1) do |count|%>
/			<th><%=@title_for_month[count].to_date.strftime("%b") %></th>
/		<% end %>
/	</tr>

/	<% @all_dates.keys.sort.each_with_index do |thumbid, index| %>
/		<tr>
/			<td><%=index+1 %></td>
/			<td><%#=@all_thumbs[index] %>for checking
/				<% unless @staff_thumb.include?(@all_thumbs[index]) %>
/					<font color=red>Staff not exist in Staff Info (thumb_id : <%=@all_thumbs[index] %>)</font>
/				<% else %>
/					<% @staff_info.each do |staff| %>
/						<%= staff.staff_thumb if staff.thumb_id == @all_thumbs[index] %>
/					<% end %>
/				<% end %>
/			</td>
/			<td>
/				<% unless @staff_thumb.include?(@all_thumbs[index]) %>
/					<font color=red>No record</font>
/				<% else %>
/					<% @staff_info.each do |staff| %>
/						<%= staff.render_unit if staff.thumb_id == @all_thumbs[index] %>
/					<% end %>
/				<% end %>
/			</td>
/			<% @all_begin_months = [] %>
/			<% for dailydate in @all_dates[thumbid].map(&:logged_at) %> 
/				<% @all_begin_months << dailydate.in_time_zone('UTC').to_date.beginning_of_month.to_s%>
/			<% end %>
/			
/			<% @in_column = [] %>
/			<% count_status = 0 %>
/			<% for every_month_begin in @all_begin_months.uniq %>
/				<% if count_status == 0 %>
/					<% previous_stat = 1 %>
/					<% previous_status = StaffAttendance.monthly_colour_status(every_month_begin, thumbid,previous_stat)%>
/				<% else %>
/					<% previous_status = StaffAttendance.monthly_colour_status(every_month_begin, thumbid,previous_stat)%>
/				<% end %>
/				<% 0.upto(@title_for_month.count-1) do |count2|%>
/					<% if every_month_begin == @title_for_month[count2] %>
/						<% @in_column[count2] = previous_status %>
/					<% end %>
/				<% end %> 
/				<% previous_stat = previous_status %>
/				<% count_status+=1 %>
/			<% end %>
/			
/			<% 0.upto(@title_for_month.count-1) do |count2| %>
/				<% if @in_column[count2] == 1 %>
/					<td style="background:#F7F3A4;text-align:center;">K</td>
/				<% elsif @in_column[count2] == 2 %>
/					<td style="background:#7C8;text-align:center;">H</td>
/				<% elsif @in_column[count2] == 3 %>
/					<td style="bakground:#F77;;text-align:center;">M</td>
/				<% else %>
/					<td>&nbsp;</td>
/				<% end %>
/			<% end %>
/			
/			UNHIDE for checking
/			<td><%# count3=0 %>
/				<%# for begin_month in @all_begin_months.uniq       display beginning month set of each staff %>
/					<%#= begin_month %><%# count3+=1 %>
/					<%# if count3 < @all_begin_months.uniq.count-1 %>,<%# end %>
/				<%# end %>thumb_id = <%#=thumbid%>
/			</td>
/		</tr>
/
/	<% end %>
/</table>	

