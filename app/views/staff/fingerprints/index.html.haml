-model_class = Fingerprint
.page-header
  %h1= t('fingerprint.title')
= render 'shared/flashes'
  
.navbar.navbar-inverse{role: "navigation", style: "padding-right:40px;"}
  /%ul.nav.navbar-nav
  /  %li= link_to content_tag(:li, fa_icon("asterisk", text: (t 'actions.new'))), new_staff_attendance_path
  %ul.nav.navbar-nav
    - permitted_to? :manage,  :staff_staff_attendances do
      %li= link_to content_tag(:li, fa_icon("asterisk", text: (t 'staff_attendance.list1'))), staff_staff_attendances_path
    - permitted_to? :manager, :staff_staff_attendances do
      %li= link_to content_tag(:li, fa_icon("asterisk", text: (t 'attendance.title'))), '/attendance/manager'
    - permitted_to? :index_admin, :staff_fingerprints do
      %li= link_to content_tag(:li, fa_icon("asterisk", text: (t 'fingerprint.title3'))), index_admin_staff_fingerprints_path
  %ul.nav.navbar-nav.navbar-right
    /%li.toga= link_to content_tag(:li, fa_icon("search", text: (t 'actions.search'))), "#", class: "toga"
    /%li= link_to content_tag(:li, fa_icon("print", text: (t 'actions.print'))), "#", class: 'bogus'

.row
  %table.table-striped.table-hover.ogma
    %thead
      %tr
        %th{width: '10%'}=t 'attendance.attdate'
        %th{width: '10%'}=t 'attendance.time_in'
        %th{width: '10%'}=t 'attendance.time_out'
        %th{width: '20%'}=t 'attendance.staff_id'
        %th{width: '20%'}=t 'attendance.reason'
        %th{width: '20%'}=t 'attendance.approve_id'
        %th{width: '10%'}=t 'attendance.approvestatus'
    %tbody
      /= render "index_search"
      %tr
        %td.group3{colspan: 7}=t 'fingerprint.approval_title'
      
      /= StaffAttendance.peeps(current_user) - check subordinate for current_user - for approval purpose
      - if @approvefingerprints.size > 0
        - for fingerprint in @approvefingerprints
          - if fingerprint.ftype!=3
            - fdate_start=fingerprint.fdate.to_time.beginning_of_day
            - fdate_end=fingerprint.fdate.to_time.end_of_day
            - sa_rec_in = StaffAttendance.where('logged_at>=? and logged_at<=?', fdate_start, fdate_end).where('log_type=? or log_type=?', 'I','i').where(thumb_id: fingerprint.thumb_id)
            - sa_rec_out = StaffAttendance.where('logged_at>=? and logged_at<=?', fdate_start, fdate_end).where('log_type=? or log_type=?', 'O','o').where(thumb_id: fingerprint.thumb_id)
          %tr
            %td=h fingerprint.fdate.strftime('%d-%m-%Y')
            %td.centre
              - if fingerprint.ftype==1 || fingerprint.ftype==3
                .text-red=t('fingerprint.no_record')
              - else
                = sa_rec_in.first.logged_at.strftime('%H:%M')
            %td.centre
              - if fingerprint.ftype==2 || fingerprint.ftype==3
                .text-red=t('fingerprint.no_record')
              - else
                = sa_rec_out.first.logged_at.strftime('%H:%M')
            %td=h fingerprint.owner.name 
            %td=h fingerprint.reason
            %td= fingerprint.try(:approvedby).try(:name) if fingerprint.is_approved == true
            %td
              - if fingerprint.reason? && (fingerprint.is_approved == nil)
                /= link_to image_tag("approval.png", :border => 0, :title => 'Approval'), :controller=> 'fingerprints', :action => 'approval', :id => fingerprint
                = link_to (fa_icon("thumbs-o-up", text: (t 'approve'))), approval_staff_fingerprints_path(id: fingerprint)
              - elsif fingerprint.is_approved == true  
                = fa_icon("check")
              - elsif fingerprint.is_approved == false  
                = fa_icon("times")
                
      %tr
        %td.group3{colspan: 7}=t 'fingerprint.title'
        /=t 'fingerprint.title'+" | "
        /= link_to (t 'attendance.new_fingerprint'), new_staff_fingerprint_path
      %tr
        %td{:colspan => "7"}
          = form_for [:staff, @fingerprint], html: { multipart: true, class: 'form-horizontal' }  do |f| 
            = f.hidden_field :thumb_id, value: @current_user.userable.thumb_id
            .col-md-1= f.text_field :fdate, class: 'form-control date_picker_reverse'
            .col-md-4= submit_tag t('fingerprint.new')
            .col-md-5= t('fingerprint.notes')


            /, class: "btn btn-link"
      - for fingerprint in @fingerprints
        - if fingerprint.ftype!=3
          - fdate_start=fingerprint.fdate.to_time.beginning_of_day
          - fdate_end=fingerprint.fdate.to_time.end_of_day
          - sa_rec_in = StaffAttendance.where('logged_at>=? and logged_at<=?', fdate_start, fdate_end).where('log_type=? or log_type=?', 'I','i').where(thumb_id: current_user.userable.thumb_id)
          - sa_rec_out = StaffAttendance.where('logged_at>=? and logged_at<=?', fdate_start, fdate_end).where('log_type=? or log_type=?', 'O','o').where(thumb_id: current_user.userable.thumb_id)
        %tr
          %td=h link_to fingerprint.fdate.try(:strftime, '%d-%m-%Y'), staff_fingerprint_path(fingerprint)
          %td.centre
            - if fingerprint.ftype==1 || fingerprint.ftype==3
              .text-red=t('fingerprint.no_record')
            - else
              = sa_rec_in.first.logged_at.strftime('%H:%M')
          %td.centre
            - if fingerprint.ftype==2 || fingerprint.ftype==3
              .text-red=t('fingerprint.no_record')
            - else
              = sa_rec_out.first.logged_at.strftime('%H:%M')
          %td=h fingerprint.try(:owner).try(:staff_with_rank)
          %td=h fingerprint.reason.blank? ? (t 'staff_attendance.reason_not_submitted') : fingerprint.reason
          %td=h fingerprint.approved_by.blank? ? "" : fingerprint.try(:approver).try(:staff_name_with_position)
          %td 
            - if fingerprint.is_approved == true
              = fa_icon("check")
            - elsif fingerprint.is_approved == false
              = fa_icon("times") 
%BR
%BR
%BR
%BR