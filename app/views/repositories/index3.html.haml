=@rep.count
=@repos.count
=@repositories.count
= @per_vessel
- if params[:page]
  =params[:page]
- else
  page satu

- model_class = Repository
.page-header
  %h1= t('repositories.list2')
  
.navbar.navbar-inverse{role: "navigation", style: "padding-right:40px;"}
  %ul.nav.navbar-nav
    - permitted_to? :create, :repositories do
      %li= link_to content_tag(:li, fa_icon("asterisk", text: (t 'actions.new'))), new2_repositories_path
    - permitted_to? :manage, :library_librarytransactions do
      %li= link_to content_tag(:li, fa_icon("th-list", text: (t 'library.transaction.title'))), repository_loan_library_librarytransactions_path
  %ul.nav.navbar-nav.navbar-right
    %li= link_to content_tag(:li, fa_icon("search-plus", text: (t 'equery.title2'))), new_equery_report_repositorysearch_path(searchrepotype: '2')
    %li= link_to content_tag(:li, fa_icon("search", text: (t 'actions.search'))), "#", class: "index_search_bar"
    %li= link_to  (fa_icon "file-pdf-o", text: (t 'print')), repository_list2_repositories_path(params.merge(format: 'pdf' ))

.row
  .col-md-12
    .alert.alert-warning.small
      %strong=t 'repositories.legend'
      %table
        %tr
          %td{colspan: 2}="<u>#{(t 'column')} : #{(t 'repositories.loan')}</u>".html_safe
          %td
          %td{colspan: 2}="<u>#{(t 'column')} : #{(t 'repositories.e_document')}</u>".html_safe
          %td
        %tr
          %td.centre{width: '5%', style: 'color: black;'}=fa_icon("plus-circle")
          %td{width: '20%'}=(t 'repositories.loan_allowed')
          %td{width: '5%'}
          %td.centre{width: '5%', style: 'color: black;'}=fa_icon("file-pdf-o")
          %td{width: '20%'}=(t 'repositories.available')
          %td{width: '45%'}
        %tr
          %td.centre.text-red=fa_icon("exclamation-circle")
          %td=(t 'repositories.loan_prohibited')
          %td
          %td.centre.text-red=fa_icon("chain-broken")
          %td=(t 'repositories.not_available')
          %td
            
  %table.table-striped.table-hover.ogma
    %thead
      %tr
        %th{width: '5%'} No
        /%th{width: '18%'}=sort_link(@search, :vessel, (t 'repositories.vessel'))
        %th{width: '40%'}= sort_link(@search, :title, (t 'repositories.document_title'))
        %th{width: '20%'}= sort_link(@search, :refno, (t 'repositories.refno2'))
        %th{width: '9%'}= sort_link(@search, :publish_date, (t 'repositories.publish_date'))
        %th{width: '5%'}=(t 'repositories.master')+"?"
        %th{width: '15%', colspan: 2}=(t 'repositories.classification')+" | "+(t 'repositories.loan')
        %th{width: '6%'}=(t 'repositories.e_document')
        
    %tbody
      = render "repositories/digital_library/index_search"
      - cnt=0
      /=@repositories.group_by{|x|x.vessel_class}.count
      /- @repositories.group_by{|x|x.vessel_class}.sort.each do |vessel_class, mrepositories|
      /  /%tr
      /  /  %td.group{colspan: 9}=mrepositories[0].render_vessel_class
          
      /  /display by vessel of current   
      /  - vessel_class_name=[ ['KD Jebat', 'KD Lekiu'], ['KD Kasturi', 'KD Lekir'], ['KD Pahang', 'KD Kelantan', 'KD Selangor', 'KD Terengganu', 'KD Kedah','KD Perak'],['KD Mahawangsa'],['KLD Tunas Samudera', 'KD Perantau']]
      /  - current_vessel_list=vessel_class_name[vessel_class.to_i-1]
      /  - per_vessel= Hash[current_vessel_list.map{|x|[x, Hash["master" => [], "specific" =>[] ]]}]
      /  /- current_vessel_list1.each do |ves|
        
      /- if params[:page]
      /  ="page : "+params[:page].to_s
      /  - first_rec=params[:page].to_i-1
      /  - last_rec=(params[:page].to_i*20)
      /- else
      /  first page
      /  - first_rec=1
      /  - last_rec=20

      /- per_vessel_count2=0
      /- per_vessel_count_arr=[]
      /- per_vessel_count_arr2=[0]
      /- @per_vessel.each do |vess, repo_sets|
      /  - per_vessel_count=0
      /  - repo_sets.each do |repo_set|
      /    $$
      /    =repo_set[1]
      /    ***
      /    = repo_set[1].count
      /    - per_vessel_count+= repo_set[1].count
      /    - per_vessel_count2+= repo_set[1].count
      /  ^^
      /  =per_vessel_count
      /  =per_vessel_count2
      /  - per_vessel_count_arr << per_vessel_count
      /  - per_vessel_count_arr2 << per_vessel_count2
      /  %br
        
      /%BR
      /=per_vessel_count_arr
      /%br
      /=per_vessel_count_arr2
      /%BR tak sama
      =@per_vessel_count_arr
      %br
      =@per_vessel_count_arr2
          
          
      /[10, 10, 38, 38, 8, 8, 8, 8, 8, 8, 8, 46, 0] 
      /[0, 10, 20, 58, 96, 104, 112, 120, 128, 136, 144, 152, 198, 198]
      
      - vessel_sort=['KD Jebat', 'KD Lekiu', 'KD Kasturi', 'KD Lekir', 'KD Pahang', 'KD Kelantan', 'KD Selangor', 'KD Terengganu', 'KD Kedah', 'KD Perak', 'KD Mahawangsa', 'KLD Tunas Samudera', 'KD Perantau']
      
      - if params[:page]
        - no=(params[:page].to_i-1)*20
      - else
        - no=0 
       
      - for repository in @repositories
        /display heading (vessel name) - before first record of each vessel - start
        - @per_vessel_count_arr2.each_with_index do |x, ind|
          - if x==no
            %tr
              %td.text-blue.group{colspan: 8}=vessel_sort[ind]
                
        /display heading (vessel name) - before first record of each vessel - start
        
        /rescue for pages w/o heading (vessel name) before the first record - start
        - if cnt==0 && @per_vessel_count_arr2.include?(no)==false
          %tr
            %td.text-red.group{colspan: 8}
              /=no
              - checker=0
              - @per_vessel_count_arr2.each_with_index do |x, ind|
                - if x > no && checker==0
                  - checker+=1
                  = vessel_sort[ind-1]
                  .small{style: 'font-weight: normal; font-style: italic;'}=(t 'repositories.continued_from')
        /rescue for pages w/o heading (vessel name) before the first record - end 
        
        /display all records
        - no+=1
        - cnt+=1
        %tr
          %td.centre=cnt
          %td= link_to repository.title, repository_path(repository)
          %td
            /=repository.id
            =repository.refno
            .text-grey.small{style: 'font-style: italic;'}="("+(t 'repositories.serial_no')+": "+repository.code+")"
          %td.centre=repository.publish_date
          %td.centre=repository.vessel.blank? ? "(M)" : "(S)"
          %td.centre{width: '8%'}=repository.render_classification
          %td.centre{width: '7%'}
            - if repository.classification=="3"
              .text-red= fa_icon("exclamation-circle")
            - else
              - loaned=Librarytransaction.marine_loaned_serial
              - if loaned.include?(repository.code)
                =t 'repositories.on_loan'
              - else
                =link_to (fa_icon "plus-circle"), loan_repository_path(repository)
          %td.centre
            - unless repository.uploaded.blank?
              =link_to (fa_icon "file-pdf-o"), repository.uploaded.url 
            - else
              .text-red= fa_icon("chain-broken")      

.right{style:"padding:0 30px; margin:0;"}= paginate @repositories, :theme => 'twitter-bootstrap-3'
