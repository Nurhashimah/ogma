.row
  .col-md-10.col-md-offset-1
    / Nav tabs
    %ul.nav.nav-tabs
      %li.active= link_to (t 'document.document_details'),"#details_edit", "data-toggle" => "tab"
      %li=link_to (t 'document.circulation_details'), "#circulation_details_edit", "data-toggle" => "tab"
      %li=link_to (t 'document.circulation1_action'), "#action_details_edit", "data-toggle" => "tab"  if @document.circulations.count > 0 
      
    .tab-content{style:"padding-top:1em"}
      #details_edit.tab-pane.active
        %br
        - if @document.staffs.pluck(:staff_id).include?(@current_user.userable_id)==true
          - if @current_user.roles.pluck(:authname).include?("administration") || @current_user.roles.pluck(:authname).include?("documents_module_manage") || @current_user.roles.pluck(:authname).include?("e_filing")
            = render 'tab_details_edit', :f => f
          - else
            = render 'tab_details'
          %br
        - else
          = render 'tab_details_edit', :f => f

      // TODO - chosen-select - didn't work with .tab-pane
      .row
        .col-md-offset-2.col-sm-8
          .form-group
            /full group listing for selection - sample: [["Kumpulan : Teknologi Maklumat", [117, 3]], ["Kumpulan : Unit Latihan", [117, 48]]]
            - group_list=Group.all.collect{|x|[(t 'group.groups')+x.name, User.where(id: (x.members[:user_ids]-[""])).pluck(:userable_id) ]}
            
            /selected recipients - staff_ids (individual & group) - sample: [87, 117, 3, 57, 101]
            - recipients_staffids=@document.circulations.pluck(:staff_id)
            
            - Group.all.each do |x|
              /group members (staff_id) in array - sample: [117, 3]
              - group_staffids=User.where(id: x.listing).pluck(:userable_id)
              
              /group members (staff_id) in string - sample: (slist="3,117", rlist="117,3")
              - slist=""
              - rlist=""
              - group_staffids.sort.each_with_index{|y, ind|slist+=y.to_s; slist+="," if ind < (x.listing.size)-1}
              - group_staffids.sort.reverse.each_with_index{|y, ind|rlist+=y.to_s; rlist+="," if ind < (x.listing.size)-1}
              
              /recipients (staff_id) in string - sample: "87, 117, 3, 57, 101"
              - recipients_staffids_list=""
              - recipients_staffids.each_with_index{|t, ind|recipients_staffids_list+=t.to_s; recipients_staffids_list+="," if ind < recipients_staffids.size-1}
              
              /When recipients (previously save circulation recs) contains ALL members of a group
              - if recipients_staffids_list.include?(slist) || recipients_staffids_list.include?(rlist)
                /remove staff_ids (of group) fr recipients_staffids & re-add in an Array form
                - recipients_staffids-=group_staffids
                - recipients_staffids+=[group_staffids]
                
            = recipients_staffids2=@document.recipients_list

            
            /// NOTE - this part is to capture currently selected staff_id for circulation
            = f.label  t 'document.circulate_to' , for: :attached_name
            = f.select(:recipients, (Staff.order(rank_id: :asc, name: :asc).map(&:staff_rank_unit_id))+group_list, {selected: recipients_staffids}, { multiple: true , class: "chosen-select form-control" })
            
            //// NOTE - this part to capture previously saved circulation records
            = f.fields_for :circulations do |builder|
              = builder.hidden_field :staff_id
              = builder.hidden_field :document_id, :value => @document.id
              = builder.hidden_field :college_id, :value => current_user.college_id
            
      #circulation_details_edit.tab-pane
        %br  
        - if @document.staffs.pluck(:staff_id).include?(@current_user.userable_id)==true
          - if @current_user.roles.pluck(:authname).include?("administration") || @current_user.roles.pluck(:authname).include?("documents_module_manage") || @current_user.roles.pluck(:authname).include?("e_filing")
            = render 'tab_circulation_details_edit', :f => f
          - else
            = render 'tab_circulation_details'
          %br
        - else
          = render 'tab_circulation_details_edit', :f => f
      
      - if @document.circulations.count > 0 
        #action_details_edit.tab-pane
          %br
          - if @document.staffs.pluck(:staff_id).include?(@current_user.userable_id)==true || @current_user.roles.pluck(:authname).include?("administration") || @current_user.roles.pluck(:authname).include?("documents_module_manage")
            = render 'tab_action_details_edit', :f => f
            = f.hidden_field :id, :value => @document.id
          - else
            = render 'tab_action_details'
