- model_class = Accession
.page-header
  %h1= t('library.reservation.list')
  
.navbar.navbar-inverse{role: "navigation", style: "padding-right:40px;"}
  %ul.nav.navbar-nav
    %li=link_to content_tag(:li, fa_icon("th-list", text: (t 'library.book.list'))), library_books_path
  %ul.nav.navbar-nav.navbar-right
    %li.toga= link_to content_tag(:li, fa_icon("search", text: (t 'actions.search'))), "#", class: 'index_search_bar'
    /%li= link_to  (fa_icon "file-pdf-o", text: (t 'print')),  academicsession_report_training_academic_sessions_path(params.merge(format: 'pdf' ))

.row
  %table.table-striped.table-hover.ogma
    %thead
      %tr
        %th{width: '23%'}=sort_link(@search, :book_title, (t 'library.book.title'))
        %th{width: '10%'}=sort_link(@search, :accession_no, (t 'library.reservation.accession_no'))
        %th{width: '7%'}=(t 'library.reservation.staff')+" / "+(t 'library.reservation.student')
        %th{width: '16%'}= t 'library.reservation.borrowed_by'
        %th{width: '8%'}= t 'library.reservation.returnduedate'
        %th{width: '7%'}=(t 'library.reservation.staff')+" / "+(t 'library.reservation.student')
        %th{width: '20%'}= t 'library.reservation.reserved_by'
        %th{width: '8%'}= (t 'library.reservation.reservation_date')+(t 'library.reservation.expired_reservation')
        - permitted_to? :manage, :library_librarytransactions do
          %th{width: '1%'}

    %tbody
    = render "index_search"
    - @accessions.each do |accession| 
      - count=0
      - unless accession.reservations.blank?
        - for reserve in accession.reservations.values
          /borrower section
          - loan=Librarytransaction.where(accession_id: accession.id).last
          - if loan.ru_staff==true
            - borrower=loan.staff.staff_with_rank
            - usrtype=(t 'library.reservation.staff')
          - elsif loan.ru_staff==false
            - borrower=loan.student.student_with_rank
            - usrtype=(t 'library.reservation.student')
          /reserver section
          - user_rec=User.find(reserve["reserved_by"].to_i)
          - if user_rec.userable_type=="Staff"
            - reserver=user_rec.userable.staff_with_rank
            - reservertype=(t 'library.reservation.staff')
          - elsif user_rec.userable_type=="Student"
            - reserver=user_rec.userable.student_with_rank
            - reservertype=(t 'library.reservation.student')
            
          %tr
            - rspan=accession.reservations.values.count
            - if count==0
              /1st line only (per accession)
              %td{rowspan: "#{rspan}"}=h accession.book.title
              %td{rowspan: "#{rspan}"}=link_to accession.accession_no, library_accession_path(accession)
              %td.centre{rowspan: "#{rspan}"}= loan.returned==true ? "-" : usrtype
              %td{rowspan: "#{rspan}"}= loan.returned==true ? "-" : borrower
              - if loan.returnduedate < Date.today
                %td.text-red{rowspan: "#{rspan}"}= loan.returned==true ? "-" : loan.returnduedate.strftime('%d-%m-%Y')
              - else
                %td{rowspan: "#{rspan}"}= loan.returned==true ? "-" : loan.returnduedate.strftime('%d-%m-%Y')
            /1st & subsequent lines
            - if loan.returned==true && count==0
              %td.centre.text-blue=reservertype
              %td
                .text-blue="#{count+1}) "+reserver
                .text-blue=(t 'library.reservation.expired_date')
              %td
                .text-blue.centre=reserve["reservation_date"]
                .red-white.centre=(loan.returneddate+3.days).strftime('%d-%m-%Y')
              - permitted_to? :manage, :library_librarytransactions do
                %td
                  /New librarytransaction form here----
                  = render partial: "transform_loan", locals: {user_rec: user_rec, accession: accession, reserve: reserve, job_type: 'index'}
            - else
              %td.centre=reservertype
              %td="#{count+1}) "+reserver
              %td.centre=reserve["reservation_date"]
              - permitted_to? :manage, :library_librarytransactions do
                %td
          - count+=1

  .right{style:"padding:0 30px; margin:0;"}= paginate @accessions, :theme => 'twitter-bootstrap-3'