- model_class = Accession
.page-header
  %h1= t 'library.reservation.title'

= render 'shared/flashes'

.row
  = form_for [:library, @accession], html: { multipart: true, class: 'form-horizontal' }  do |f| 
    = render 'shared/error_messages', object: f.object
    .row
      .col-md-8.col-md-offset-3
        %dl.dl-horizontal
          %dt= t 'library.book.title'
          %dd=@accession.book.title
          
          %dt=t 'library.reservation.accession_no'
          %dd=@accession.accession_no
          
          - loan=Librarytransaction.where(accession_id: @accession.id).last
          - if loan.ru_staff==true 
            - str="#{loan.staff.staff_with_rank} (#{t 'library.reservation.staff'})"
            - email=loan.staff.coemail
            - borrower=loan.staff_id
          - elsif loan.ru_staff==false
            - str="#{loan.student.student_with_rank} (#{(t 'library.reservation.student')})"
            - email=loan.student.semail
            - borrower=loan.student_id
              
          %dt=t 'library.reservation.borrowed_by'
          %dd=email.blank? ? str : "#{str} - #{email}"
          
          %dt=t 'library.reservation.returnduedate'
          %dd=loan.returnduedate.strftime('%d-%m-%Y')
          
          - last= @accession.reservations.count rescue 0
  
          %dt= t 'library.reservation.current_list'
          %dd= t 'library.reservation.no_reservation' if last==0
          
          .row
            .col-md-8
              %br
              .small=t 'library.reservation.max_reservation'
              /1) display heading once
              %table.table.table-bordered.table-sm
                - if last > 0
                  %tr
                    %th.bg-info=t 'library.reservation.queue_no'
                    %th.bg-info=t 'library.reservation.reserved_by'
                    %th.bg-info=t 'library.reservation.reservation_date'

                /- if last < 3
                /  - 0.upto(last).each do |cnt|
                
                - 0.upto(last).each do |cnt|
                  - if last <=3
                  
                    = f.fields_for :reservations do |builder|
                      - if cnt < last
                        %tr
                          %td.centre=cnt+1
                          %td
                            - reserver=User.find(@accession.reservations[cnt.to_s]['reserved_by'])
                            - reserver_type=reserver.userable_type
                            = reserver_type=='Staff' ? reserver.userable.staff_with_rank : reserver.userable.student_with_rank
                          %td=@accession.reservations[cnt.to_s]['reservation_date'] rescue nil
                        = builder.hidden_field "#{cnt}[reserved_by]", value: (@accession.reservations[cnt.to_s]['reserved_by'] rescue nil)
                        = builder.hidden_field "#{cnt}[reservation_date]", value: (@accession.reservations[cnt.to_s]['reservation_date'] rescue nil)
                    
                      - else
                        /this reservation - allow only when current_user HAVEn't reserve this item yet!
                        - if @accession.reserver_ids.include?(current_user.id)==false
                          - if borrower==current_user.userable_id
                          - else
                            = builder.hidden_field "#{cnt}[reserved_by]", value: current_user.id
                            = builder.hidden_field "#{cnt}[reservation_date]", value: Date.today.strftime("%d-%m-%Y")
                
              /2) display reservation notice
              - reserving_text=("#{t 'library.reservation.reserving'} <strong>#{last+1}</strong>. <br>#{t 'library.reservation.click_reserve'}").html_safe
              .centre
                - if last==3 
                  .text-red=(t 'library.reservation.quota_exceed')
                - else
                  - if @accession.reserver_ids.include?(current_user.id)==false
                    - if borrower==current_user.userable_id
                      .text-red=t 'library.reservation.reservation_prohibited'
                    - else
                      .text-blue=reserving_text
                  - else
                    .text-red=t 'library.reservation.reserve_once'

    %br   
    .row
      .form-group
        .col-md-1.col-md-offset-4
          = link_to content_tag(:i, "", :class => "fa fa-arrow-left ") + " " + t('.back', :default => t("helpers.links.back")), library_books_path, :class => 'btn btn-default'
        .col-md-2
          - unless last==3 
            - if @accession.reserver_ids.include?(current_user.id)==false
              - unless borrower==current_user.userable_id
                .div{style: "margin-left:20px;"}
                  = f.submit t('library.reservation.reserve'), class: "btn btn-primary"

/ :javascript
/ 
/ $(document).ready(function(){
/   $("input[id='is_extended']").change(function() {  
/     if($('#is_extended').is(':checked')) { 
/       $('.span_checked_on').show("highlight");
/     }
/     else
/     {$('.span_checked_on').hide(); }
/   });
/   $("input[id='is_extended']").each(function() {  
/     if($('#is_extended').is(':checked')) { 
/       $('.span_checked_on').show("highlight");
/     }
/     else
/     {$('.span_checked_on').hide();}
/     
/   });
/ });

